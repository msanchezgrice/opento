<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Dashboard â€” Opento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" sizes="512x512" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="lib/supabase-client.js"></script>
  <script src="lib/session.js"></script>
</head>
<body>
  <div class="app-nav">
    <div class="container">
      <div class="brand"><img class="brand-logo" src="assets/logo.svg" alt=""><div class="brand-name">Opento</div></div>
      <div class="chips">
        <div class="chip">Dashboard</div>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <a class="btn gray" id="viewProfileBtn" href="#" target="_blank">View Public Profile</a>
        <button class="btn ghost" onclick="if(confirm('Sign out?')) { signOut(); window.location.href='/'; }" style="padding: 8px 12px;">Sign Out</button>
      </div>
    </div>
  </div>

  <div class="container section" style="max-width: 1200px; margin-top: 40px;">
    <!-- Loading state -->
    <div id="dashboardLoading" style="text-align: center; padding: 60px 20px;">
      <div class="small">Loading your dashboard...</div>
    </div>

    <!-- Main dashboard content (hidden until loaded) -->
    <div id="dashboardContent" style="display: none;">
      <!-- Header with agent info -->
      <div class="card" style="margin-bottom: 32px;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="handle-avatar" id="dashAvatar" style="width: 80px; height: 80px; font-size: 32px;">â€”</div>
          <div style="flex: 1;">
            <h1 id="dashName" style="margin: 0 0 8px 0;">Your Agent</h1>
            <div class="small" style="color: #64748b;">@<span id="dashHandle">â€”</span></div>
            <div style="margin-top: 12px;">
              <a id="viewPublicProfile" href="#" target="_blank" class="btn small">View Public Profile</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab navigation -->
      <div class="card" style="margin-bottom: 24px;">
        <div style="display: flex; gap: 16px; border-bottom: 1px solid var(--border); padding-bottom: 0;">
          <button class="tab-btn active" data-tab="profile" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid var(--primary); font-weight: 600; color: var(--primary);">Profile</button>
          <button class="tab-btn" data-tab="agent-settings" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--muted);">Agent Settings</button>
          <button class="tab-btn" data-tab="settings" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--muted);">Settings</button>
          <button class="tab-btn" data-tab="skills" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--muted);">Skills</button>
          <button class="tab-btn" data-tab="intros" style="padding: 12px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: var(--muted);">Intro Requests</button>
        </div>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content" data-tab="profile">
        <div class="card">
          <h2>Profile Information</h2>
          <p class="small" style="color: #64748b; margin-bottom: 24px;">This information appears on your public agent page.</p>
          
          <!-- Photo Upload Section -->
          <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 32px;">
            <h3 style="margin: 0 0 16px;">Profile Photo</h3>
            <div style="display: flex; align-items: center; gap: 24px;">
              <!-- Current Photo Preview -->
              <div id="photoPreview" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; background: var(--chip); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: 700; color: var(--chip-text); border: 3px solid var(--border);">
                â€”
              </div>
              
              <!-- Upload Controls -->
              <div style="flex: 1;">
                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                <button type="button" class="btn primary" onclick="document.getElementById('photoInput').click()">
                  Upload Photo
                </button>
                <button type="button" id="removePhotoBtn" class="btn gray" style="margin-left: 12px; display: none;">
                  Remove Photo
                </button>
                <div class="small muted" style="margin-top: 12px;">
                  JPG, PNG or GIF. Max 10MB. Square images work best.
                </div>
                <div id="photoUploadStatus" style="margin-top: 12px; font-size: 14px;"></div>
              </div>
            </div>
          </div>
          
          <form id="profileForm" style="display: grid; gap: 20px;">
            <label class="input">
              <span>Display Name *</span>
              <input type="text" id="profileName" required placeholder="Your full name">
            </label>
            
            <label class="input">
              <span>Role / Title *</span>
              <input type="text" id="profileRole" required placeholder="e.g., Performance Marketer">
            </label>
            
            <label class="input">
              <span>Bio / Summary</span>
              <textarea id="profileSummary" rows="4" placeholder="A brief description of your expertise and background"></textarea>
            </label>
            
            <label class="input">
              <span>Location</span>
              <input type="text" id="profileLocation" placeholder="e.g., Austin, TX">
            </label>
            
            <label class="input">
              <span>Email</span>
              <input type="email" id="profileEmail" placeholder="your@email.com">
              <div class="small muted">For notifications (not shown publicly)</div>
            </label>
            
            <div>
              <button type="submit" class="btn primary">Save Profile</button>
              <button type="button" class="btn gray" onclick="window.location.reload()" style="margin-left: 12px;">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Agent Settings Tab (NEW) -->
      <div class="tab-content" data-tab="agent-settings" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Left: Settings Summary -->
          <div class="card">
            <h2>Your Agent Settings</h2>
            <p class="small" style="color: #64748b; margin-bottom: 24px;">Review your agent configuration at a glance.</p>
            
            <div style="display: grid; gap: 20px;">
              <div>
                <div class="small muted" style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Rates</div>
                <div><strong id="summaryConsultFloor">$75</strong> per 30 min consult</div>
                <div><strong id="summaryAsyncFloor">$12</strong> per 5 min async task</div>
              </div>
              
              <div>
                <div class="small muted" style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Availability</div>
                <div><strong id="summaryWeeklyHours">6</strong> hours per week</div>
                <div id="summaryAvailabilityWindow">Monâ€“Thu 11aâ€“4p CT</div>
              </div>
              
              <div>
                <div class="small muted" style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Work Categories</div>
                <div id="summaryCategories" class="chips" style="margin-top: 8px;">
                  <div class="chip">Loading...</div>
                </div>
              </div>
              
              <div>
                <div class="small muted" style="text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Privacy</div>
                <div id="summaryPrivacy">
                  <div style="margin-bottom: 4px;">âœ“ Anonymous first</div>
                  <div>âœ“ Consent reminders</div>
                </div>
              </div>
              
              <div style="margin-top: 16px;">
                <button class="btn gray" onclick="document.querySelector('[data-tab=settings]').click()">Edit Settings</button>
              </div>
            </div>
          </div>
          
          <!-- Right: Chat with Your Rep -->
          <div class="card">
            <h2>Chat with Your Rep</h2>
            <p class="small" style="color: #64748b; margin-bottom: 20px;">Ask questions about your agent settings and how to optimize your profile.</p>
            
            <div style="text-align: center; padding: 60px 20px;">
              <div style="font-size: 48px; margin-bottom: 16px;">ðŸ’¬</div>
              <h3 style="margin: 0 0 12px;">Chat with Your Agent Rep</h3>
              <p class="small muted">Get personalized advice about your settings, rates, and how to optimize your profile for better matches.</p>
              <button class="btn primary" onclick="openDashboardChat()" style="margin-top: 20px;">Start Chat</button>
            </div>
            
            <div style="margin-top: 20px;">
              <div class="small muted" style="text-align: center; margin-bottom: 12px;">Quick questions:</div>
              <div class="chips" style="justify-content: center;">
                <button class="chip" style="cursor: pointer;" onclick="openDashboardChat('What rates should I charge?')">What rates should I charge?</button>
                <button class="chip" style="cursor: pointer;" onclick="openDashboardChat('How do I get more matches?')">How do I get more matches?</button>
                <button class="chip" style="cursor: pointer;" onclick="openDashboardChat('How does anonymous mode work?')">How does anonymous mode work?</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" data-tab="settings" style="display: none;">
        <div class="card">
          <h2>Agent Settings</h2>
          <p class="small" style="color: #64748b; margin-bottom: 24px;">Configure your rates, availability, and work preferences.</p>
          
          <form id="settingsForm" style="display: grid; gap: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <label class="input">
                <span>Consult rate (per 30 min)</span>
                <input type="number" id="settingsConsultFloor" min="0" step="5" placeholder="75">
                <div class="small muted">Minimum for 30-minute calls</div>
              </label>
              
              <label class="input">
                <span>Async task rate (per 5 min)</span>
                <input type="number" id="settingsAsyncFloor" min="0" step="1" placeholder="12">
                <div class="small muted">Minimum for quick tasks</div>
              </label>
            </div>
            
            <label class="input">
              <span>Weekly hours target</span>
              <input type="range" id="settingsHours" min="0" max="20" value="6">
              <span id="settingsHoursVal" class="chip">6 hrs / week</span>
            </label>
            
            <label class="input">
              <span>Availability window</span>
              <select id="settingsWindow">
                <option>Monâ€“Thu 11aâ€“4p CT</option>
                <option>Monâ€“Fri 9aâ€“5p ET</option>
                <option>Monâ€“Fri Lunch hours</option>
                <option>Tue & Thu Evenings</option>
                <option>Weekends only</option>
                <option>Flexible / By appointment</option>
              </select>
            </label>
            
            <div>
              <h3 style="margin-bottom: 16px;">Work Categories</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;" id="categoriesContainer">
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" name="category" value="Growth audits">
                  <span>Growth audits & consults</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" name="category" value="Campaign optimization">
                  <span>Campaign optimization</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" name="category" value="Fractional retainers">
                  <span>Fractional retainers</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" name="category" value="Data labeling">
                  <span>Data labeling & QA</span>
                </label>
              </div>
            </div>
            
            <div>
              <h3 style="margin-bottom: 16px;">Privacy Settings</h3>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                <input type="checkbox" id="settingsAnonFirst" checked>
                <div>
                  <div style="font-weight: 600;">Anonymous first</div>
                  <div class="small muted">Identity reveals only after accept + escrow</div>
                </div>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; margin-top: 12px;">
                <input type="checkbox" id="settingsConsentReminders" checked>
                <div>
                  <div style="font-weight: 600;">Consent reminders</div>
                  <div class="small muted">Show what's shared before each accept</div>
                </div>
              </label>
            </div>
            
            <div>
              <button type="submit" class="btn primary">Save Settings</button>
              <button type="button" class="btn gray" onclick="window.location.reload()" style="margin-left: 12px;">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Skills Tab -->
      <div class="tab-content" data-tab="skills" style="display: none;">
        <div class="card">
          <h2>Your Skills</h2>
          <p class="small" style="color: #64748b; margin-bottom: 24px;">Manage the skills shown on your agent profile.</p>
          
          <div style="margin-bottom: 24px;">
            <h3 style="margin-bottom: 12px;">Current Skills</h3>
            <div id="currentSkills" class="chips" style="min-height: 48px;">
              <div class="chip">Loading...</div>
            </div>
          </div>
          
          <form id="skillsForm">
            <label class="input">
              <span>Add Skills</span>
              <input type="text" id="skillsInput" placeholder="Type skill and press Enter" list="skillsList" autocomplete="off">
              <div class="small muted">Type and press Enter or comma to add. Click X on chips to remove.</div>
            </label>
            
            <datalist id="skillsList">
              <option>performance marketing</option>
              <option>paid social</option>
              <option>seo</option>
              <option>growth marketing</option>
              <option>product management</option>
              <option>design</option>
              <option>engineering</option>
              <option>data analysis</option>
            </datalist>
            
            <div style="margin-top: 20px;">
              <button type="submit" class="btn primary">Save Skills</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Intro Requests Tab -->
      <div class="tab-content" data-tab="intros" style="display: none;">
        <div class="card">
          <h2>Intro Requests</h2>
          <p class="small" style="color: #64748b; margin-bottom: 24px;">People who want to connect with you.</p>
          
          <div id="introsLoading" style="text-align: center; padding: 40px;">
            <div class="small">Loading requests...</div>
          </div>
          
          <div id="introsList" style="display: none;"></div>
          
          <div id="introsEmpty" style="display: none; text-align: center; padding: 40px;">
            <h3>No intro requests yet</h3>
            <p class="small">When someone requests an intro through your agent page, it will appear here.</p>
            <div style="margin-top: 20px;">
              <a href="#" id="shareProfileLink" class="btn">Share Your Profile</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal (same as public pages) -->
  <div class="modal" id="chatModal" style="display: none;">
    <div class="dialog chat-dialog">
      <header>
        <div>
          <strong>Chat with <span id="displayNameChat">Your</span> Rep</strong>
          <p class="small">Get advice about your settings, rates, and profile optimization</p>
        </div>
        <button class="btn small gray" data-close="chat">Close</button>
      </header>
      <main class="chat-main">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-wrapper">
          <input type="text" id="chatInput" class="chat-input" placeholder="Type your question...">
          <button id="chatSend" class="btn primary">Send</button>
        </div>
        <div class="chat-suggestions" id="chatSuggestions"></div>
      </main>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="lib/dashboard-integration.js"></script>
  <script src="lib/nav-helper.js"></script>
  <script>
    // Dashboard chat functionality
    function openDashboardChat(initialMessage) {
      // Use current user's agent data
      const userData = window.currentUserData || {};
      
      // Set agent data for chat
      window.currentAgentData = {
        displayName: userData.displayName || 'Your Agent',
        display_name: userData.displayName || 'Your Agent',
        handle: userData.handle || 'agent',
        avatar_url: userData.avatar_url,
        avatar_initials: userData.avatarInitials,
        role: userData.role || 'Agent',
        summary: userData.summary || '',
        settings: userData.settings || {},
        skills: userData.skills || [],
        onboarding: {
          floor: userData.settings?.consult_floor_30m || 75,
          microFloor: userData.settings?.async_floor_5m || 12,
          hours: userData.settings?.weekly_hours || 6,
          window: userData.settings?.availability_window || 'Monâ€“Thu 11aâ€“4p CT'
        },
        availability: userData.settings?.availability_window || 'By appointment',
        rulesSummary: userData.settings ? 
          `${userData.settings.anonymous_first ? 'Anonymous first' : 'Public'} â€¢ $${userData.settings.consult_floor_30m || 75}/30m floor` :
          'Standard consulting rates'
      };
      
      // Initialize chat if not already initialized
      if (typeof window.initializeChat === 'function') {
        window.initializeChat();
      }
      
      // Open modal
      const chatModal = document.getElementById('chatModal');
      if (chatModal) {
        chatModal.style.display = 'flex';
        
        // Send initial message if provided
        if (initialMessage) {
          setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
              chatInput.value = initialMessage;
              document.getElementById('chatSend').click();
            }
          }, 500);
        }
      }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Opento ‚Äî Build Your Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" sizes="512x512" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="lib/supabase-client.js"></script>
  <script src="lib/session.js"></script>
  <script src="lib/resume-upload.js"></script>
</head>
<body class="onboarding-page">
  <div class="app-nav">
    <div class="container" style="gap:12px;">
      <div class="brand"><img class="brand-logo" src="assets/logo.svg" alt=""><div class="brand-name">Opento</div></div>
      <div class="goal"><span class="small">You're</span> <div class="meter"><div class="fill" style="width:0;"></div></div> <span class="small">to earning</span></div>
      <div class="progress" style="flex:1; height:8px; background:#eef2ff; border-radius:999px; overflow:hidden;"><div class="bar" style="height:100%; width:0; background:linear-gradient(90deg, #2D6FFF, #2EE6A6);"></div></div>
      <div class="step-indicator small">Step 1 of 6</div>
    </div>
  </div>

  <div class="container section onboarding-container">
    <div class="wizard">
      <!-- Step 1: Tell us about yourself -->
      <div class="step" data-step="1">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">1</div>
            <h2>Tell us about yourself</h2>
            <p class="sub">Help us understand your background so we can match you with the right opportunities.</p>
          </div>
          
          <!-- Quick Import Options -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px;">
            <!-- LinkedIn Import -->
            <div id="linkedInImportSection" style="background: linear-gradient(135deg, #0077B5, #00A0DC); border-radius: 16px; padding: 24px; color: white; cursor: pointer;" onclick="document.getElementById('linkedInImportBtn').click()">
              <div style="font-size: 40px; margin-bottom: 12px;">in</div>
              <h3 style="margin: 0 0 8px; color: white;">Import from LinkedIn</h3>
              <p style="margin: 0 0 16px; opacity: 0.95; font-size: 14px;">Auto-fill from your LinkedIn profile</p>
              <button type="button" id="linkedInImportBtn" class="btn" style="background: white; color: #0077B5; font-weight: 700; padding: 10px 20px; width: 100%;" onclick="event.stopPropagation()">
                Import Profile
              </button>
            </div>
            
            <!-- Resume Upload -->
            <div id="resumeUploadSection" style="background: linear-gradient(135deg, #7C3AED, #A78BFA); border-radius: 16px; padding: 24px; color: white; cursor: pointer;" onclick="document.getElementById('resumeInput').click()">
              <div style="font-size: 40px; margin-bottom: 12px;">üìÑ</div>
              <h3 style="margin: 0 0 8px; color: white;">Upload Resume</h3>
              <p style="margin: 0 0 16px; opacity: 0.95; font-size: 14px;">Parse your resume with AI (DOCX only)</p>
              <input type="file" id="resumeInput" accept=".docx" style="display: none;" onchange="handleResumeUpload(event)">
              <button type="button" class="btn" style="background: white; color: #7C3AED; font-weight: 700; padding: 10px 20px; width: 100%;" onclick="event.stopPropagation(); document.getElementById('resumeInput').click()">
                Choose File
              </button>
            </div>
          </div>
          
          <!-- Success messages (hidden by default) -->
          <div id="linkedInSuccess" style="display: none; background: #f0f9ff; border: 2px solid #0077B5; border-radius: 12px; padding: 16px; margin-bottom: 24px; color: #0077B5;">
            <strong>‚úì LinkedIn profile imported!</strong> Review the pre-filled information below and make any changes.
          </div>
          
          <div id="resumeSuccess" style="display: none; background: #f5f3ff; border: 2px solid #7C3AED; border-radius: 12px; padding: 16px; margin-bottom: 24px; color: #7C3AED;">
            <strong>‚úì Resume parsed successfully!</strong> Review the pre-filled information below and make any changes.
          </div>
          
          <div id="resumeLoading" style="display: none; background: #f5f3ff; border: 2px solid #7C3AED; border-radius: 12px; padding: 16px; margin-bottom: 24px; color: #7C3AED; text-align: center;">
            <div style="display: inline-block; animation: spin 1s linear infinite; font-size: 24px; margin-bottom: 8px;">‚è≥</div>
            <div><strong>Parsing your resume with AI...</strong></div>
            <div class="small" style="margin-top: 4px;">This may take 10-15 seconds</div>
          </div>
          
          <div class="inputs">
            <label class="input">
              <span>Years of experience</span>
              <select id="years" required>
                <option value="">Select years...</option>
                <option value="0">0 - Just starting</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="12">12</option>
                <option value="15">15</option>
                <option value="18">18</option>
                <option value="20">20+</option>
              </select>
            </label>
            <label class="input">
              <span>Location (city, region)</span>
              <input id="location" type="text" list="locList" placeholder="e.g., Austin, TX" required>
              <div class="small muted">Your timezone helps with scheduling</div>
            </label>
            <label class="input" style="grid-column: 1 / -1;">
              <span>Your skills</span>
              <div class="skills-selector">
                <input id="skillsInput" type="text" placeholder="Start typing to search skills..." autocomplete="off">
                <input id="skills" type="hidden" required>
                
                <!-- Custom dropdown (hidden by default) -->
                <div id="skillsDropdown" class="skills-dropdown" style="display: none;">
                  <div class="skills-dropdown-loading">Loading skills...</div>
                </div>
              </div>
              
              <!-- Selected skills shown as chips -->
              <div id="skillsChips" class="skills-chips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; min-height: 32px;"></div>
              <div class="small muted">Start typing to search, click to add. Click X on chips to remove.</div>
            </label>
            
            <!-- Enhanced fields -->
            <label class="input">
              <span>Seniority level</span>
              <select id="seniorityLevel" required>
                <option value="">Select level...</option>
                <option value="Junior">Junior (0-3 years)</option>
                <option value="Mid">Mid-level (3-6 years)</option>
                <option value="Senior" selected>Senior (6-10 years)</option>
                <option value="Lead">Lead (10-15 years)</option>
                <option value="Executive">Executive (15+ years)</option>
              </select>
              <div class="small muted">Helps match you with appropriate opportunities</div>
            </label>
            
            <label class="input">
              <span>Current company (optional)</span>
              <input id="currentCompany" type="text" placeholder="e.g., Google, Stripe">
              <div class="small muted">Adds credibility to your profile</div>
            </label>
            
            <label class="input">
              <span>Years in current role</span>
              <select id="yearsInRole">
                <option value="">Select...</option>
                <option value="0">Less than 1 year</option>
                <option value="1">1 year</option>
                <option value="2" selected>2 years</option>
                <option value="3">3 years</option>
                <option value="4">4 years</option>
                <option value="5">5 years</option>
                <option value="6">6+ years</option>
              </select>
            </label>
            
            <label class="input" style="grid-column: 1 / -1;">
              <span>Industries you've worked in</span>
              <div id="industriesSelector" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; min-height: 80px; cursor: pointer; background: #fafafa;">
                <div class="small muted" style="width: 100%; text-align: center; padding: 20px 0;" id="industriesPlaceholder">Click to select industries...</div>
              </div>
              <div class="small muted">Select all that apply (helps with matching)</div>
            </label>
          </div>
          
          <!-- Industries modal -->
          <div id="industriesModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 16px; padding: 32px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
              <h3 style="margin: 0 0 16px;">Select Industries</h3>
              <p class="small muted" style="margin-bottom: 20px;">Choose the industries you have experience in</p>
              <div id="industriesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <!-- Will be populated with checkboxes -->
              </div>
              <div style="display: flex; gap: 12px;">
                <button type="button" class="btn primary" onclick="closeIndustriesModal()">Done</button>
                <button type="button" class="btn gray" onclick="clearIndustries()">Clear All</button>
              </div>
            </div>
          </div>
          
          <datalist id="locList">
            <option>Austin, TX</option>
            <option>San Francisco, CA</option>
            <option>New York, NY</option>
            <option>Seattle, WA</option>
            <option>Los Angeles, CA</option>
            <option>Chicago, IL</option>
            <option>Boston, MA</option>
            <option>Denver, CO</option>
            <option>London, UK</option>
            <option>Berlin, DE</option>
            <option>Toronto, ON</option>
            <option>Remote</option>
          </datalist>
          <div class="step-actions">
            <button class="btn primary" data-next>Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 2: Tell Your Story (NEW) -->
      <div class="step" data-step="2">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">2</div>
            <h2>Tell your story</h2>
            <p class="sub">Help brands understand what makes you unique. AI can help you write this!</p>
          </div>
          
          <div class="inputs">
            <label class="input" style="grid-column: 1 / -1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span>Professional title</span>
                <button type="button" class="btn small gray" onclick="getSuggestion('title')" style="margin-left: auto;">
                  ‚ú® Get Help
                </button>
              </div>
              <input id="professionalTitle" type="text" placeholder="e.g., Senior Growth Marketing Lead" required>
              <div class="small muted">How you describe yourself professionally (will show on your profile)</div>
            </label>
            
            <label class="input" style="grid-column: 1 / -1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span>About you (2-3 sentences)</span>
                <button type="button" class="btn small gray" onclick="getSuggestion('bio')" style="margin-left: auto;">
                  ‚ú® Get Help
                </button>
              </div>
              <textarea id="bio" rows="4" placeholder="I help B2B SaaS companies reduce CAC through experimentation and creative testing. Specialized in attribution modeling and lifecycle optimization." required></textarea>
              <div class="small muted">What problems do you solve? What makes you unique? (Write in first person)</div>
            </label>
            
            <div style="grid-column: 1 / -1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span><strong>What you're best at</strong> (3-5 bullet points)</span>
                <button type="button" class="btn small gray" onclick="getSuggestion('best_at')" style="margin-left: auto;">
                  ‚ú® Get Help
                </button>
              </div>
              <div id="bestAtList" style="display: grid; gap: 8px;">
                <input type="text" class="best-at-input" placeholder="e.g., Building acquisition funnels that convert at 20%+" data-index="0">
                <input type="text" class="best-at-input" placeholder="e.g., Reducing CAC through creative testing" data-index="1">
                <input type="text" class="best-at-input" placeholder="e.g., Attribution modeling across Meta/Google/TikTok" data-index="2">
              </div>
              <div class="small muted" style="margin-top: 8px;">Be specific! Use metrics when possible.</div>
            </div>
            
            <div style="grid-column: 1 / -1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span><strong>Recent wins or achievements</strong> (3 bullet points)</span>
                <button type="button" class="btn small gray" onclick="getSuggestion('highlights')" style="margin-left: auto;">
                  ‚ú® Get Help
                </button>
              </div>
              <div id="highlightsList" style="display: grid; gap: 8px;">
                <input type="text" class="highlight-input" placeholder="e.g., Cut blended CAC by 22% for Looply in two weeks" data-index="0">
                <input type="text" class="highlight-input" placeholder="e.g., Grew trial-to-paid conversion by 18%" data-index="1">
                <input type="text" class="highlight-input" placeholder="e.g., Managed $3.2M/yr in ad spend across 3 channels" data-index="2">
              </div>
              <div class="small muted" style="margin-top: 8px;">Include numbers and outcomes. These build credibility!</div>
            </div>
          </div>
          
          <div class="step-actions">
            <button class="btn gray" data-back>Back</button>
            <button class="btn primary" data-next>Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Your online presence -->
      <div class="step" data-step="3">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">3</div>
            <h2>Your online presence</h2>
            <p class="sub">Optional: Add your professional profiles to boost trust and match quality.</p>
          </div>
          <div class="inputs">
            <label class="input">
              <span>LinkedIn URL (optional)</span>
              <input id="linkedin" type="url" placeholder="https://www.linkedin.com/in/you">
              <div class="small muted">Signals professional presence</div>
            </label>
            <label class="input">
              <span>Twitter / X URL (optional)</span>
              <input id="twitter" type="url" placeholder="https://x.com/you">
              <div class="small muted">Shows thought leadership</div>
            </label>
            <label class="input">
              <span>Instagram URL (optional)</span>
              <input id="instagram" type="url" placeholder="https://instagram.com/you">
              <div class="small muted">For creator & brand collabs</div>
            </label>
          </div>
          <div class="step-actions">
            <button class="btn gray" data-back>Back</button>
            <button class="btn primary" data-next>Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Your availability -->
      <div class="step" data-step="3">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">3</div>
            <h2>Your availability</h2>
            <p class="sub">How many hours per week would you like to dedicate to opportunities?</p>
          </div>
          <div class="inputs">
            <label class="input availability-slider">
              <span>Weekly hours target</span>
              <input id="hours" type="range" min="0" max="20" value="6" aria-label="Weekly hours target">
              <span id="hoursVal" class="chip large-chip" aria-live="polite">6 hrs / week</span>
              <div class="small muted">Don't worry, you can adjust this anytime</div>
            </label>
            <div class="card estimate-card">
              <div class="small muted">Potential monthly earnings</div>
              <div id="earningsEstimate" class="estimate-value">$0</div>
              <div class="small muted">Based on your profile and market rates</div>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn gray" data-back>Back</button>
            <button class="btn primary" data-next>Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 4: What are you open to? -->
      <div class="step" data-step="4">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">4</div>
            <h2>What are you open to?</h2>
            <p class="sub">Select the types of work you'd like your agent to find for you. <span id="suggestionsNote" style="color: var(--primary); font-weight: 600;"></span></p>
          </div>
          
          <!-- Loading state -->
          <div id="opportunitiesLoading" style="text-align: center; padding: 60px 20px; display: none;">
            <div class="small muted">Loading personalized suggestions based on your skills...</div>
          </div>
          
          <!-- Dynamic opportunities grid -->
          <div id="opportunitiesGrid" class="options-grid"></div>
          
          <div class="step-actions">
            <button class="btn gray" data-back>Back</button>
            <button class="btn primary" data-next>Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 5: Set your rates -->
      <div class="step" data-step="5">
        <div class="step-content">
          <div class="step-header">
            <div class="step-number">5</div>
            <h2>Set your rates</h2>
            <p class="sub">Define your minimum rates and auto-book windows. Your agent will auto-decline anything below these.</p>
          </div>
          <div class="inputs">
            <label class="input">
              <span>Consult minimum ($ per 30 minutes)</span>
              <input id="floor" type="range" min="30" max="200" step="5" value="75" aria-label="Consult minimum per 30 minutes">
              <span id="floorVal" class="chip" aria-live="polite">$75</span>
              <div class="small muted">Auto-declines briefs below this</div>
            </label>
            <label class="input">
              <span>Async sprint minimum ($ per 5 minutes)</span>
              <input id="microfloor" type="range" min="5" max="40" step="1" value="12" aria-label="Async sprint minimum per 5 minutes">
              <span id="microVal" class="chip" aria-live="polite">$12</span>
              <div class="small muted">For quick tasks and QA work</div>
            </label>
            <label class="input">
              <span>Auto-book windows</span>
              <select id="autoWindow">
                <option>Mon‚ÄìThu 11a‚Äì4p CT</option>
                <option>Mon‚ÄìFri Lunch hours</option>
                <option>Tue & Thu Evenings</option>
              </select>
              <div class="small muted">Your Rep only books in these windows</div>
            </label>
          </div>
          <div class="step-actions">
            <button class="btn gray" data-back>Back</button>
            <button class="btn primary large-btn" data-finish>Build my agent</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Panel (Sticky on desktop) -->
    <div class="preview-panel">
      <div class="badge"><span class="dot"></span> Live Preview</div>
      <div class="preview-content">
        <div class="preview-card-small">
          <div class="small muted">Profile</div>
          <div id="previewYears" class="preview-value">‚Äî</div>
          <div id="previewLocation" class="preview-value">‚Äî</div>
          <div id="previewSkills" class="preview-chips"></div>
        </div>
        <div class="preview-card-small">
          <div class="small muted">Rates</div>
          <div id="previewFloor" class="preview-value">$75 / 30m</div>
          <div id="previewMicro" class="preview-value">$12 / 5m</div>
        </div>
        <div class="preview-card-small">
          <div class="small muted">Availability</div>
          <div id="previewHours" class="preview-value">6 hrs / week</div>
          <div id="previewWindow" class="preview-value">Mon‚ÄìThu 11a‚Äì4p CT</div>
        </div>
        <div class="preview-card-highlight">
          <div class="small muted">Monthly estimate</div>
          <div id="previewEstimate" class="preview-estimate">$0</div>
        </div>
        <div id="previewCategories" class="preview-chips-list"></div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="lib/skills-selector.js"></script>
  <script src="lib/onboarding-integration.js"></script>
  <script>
    // Redirect signed-in users to dashboard
    if (window.opentoSession && window.opentoSession.isSignedIn()) {
      console.log('User already signed in, redirecting to dashboard');
      window.location.href = 'dashboard.html';
    }
    
    // Initialize skills selector when page loads
    document.addEventListener('DOMContentLoaded', () => {
      if (window.initializeSkillsSelector) {
        window.initializeSkillsSelector();
      }
      
      // Initialize LinkedIn import
      initializeLinkedInImport();
      
      // Load smart opportunities when user reaches step 4
      const wizard = document.querySelector('.wizard');
      if (wizard) {
        const observer = new MutationObserver(() => {
          const step4 = document.querySelector('.step[data-step="4"]');
          if (step4 && step4.style.display !== 'none') {
            loadSmartOpportunities();
          }
        });
        observer.observe(wizard, { childList: true, subtree: true, attributes: true, attributeFilter: ['style'] });
      }
    });
    
    // LinkedIn Import Functionality
    function initializeLinkedInImport() {
      const importBtn = document.getElementById('linkedInImportBtn');
      
      if (importBtn) {
        importBtn.addEventListener('click', () => {
          // Redirect to LinkedIn OAuth
          window.location.href = '/api/auth/linkedin/authorize';
        });
      }
      
      // Check if returning from LinkedIn OAuth
      const urlParams = new URLSearchParams(window.location.search);
      const linkedInData = urlParams.get('linkedin');
      const imported = urlParams.get('imported');
      const error = urlParams.get('error');
      
      if (error) {
        const message = urlParams.get('message') || 'LinkedIn import failed';
        alert('LinkedIn Import Error: ' + message);
        // Clean URL
        window.history.replaceState({}, '', '/onboarding.html');
      }
      
      if (linkedInData && imported) {
        try {
          // Decode LinkedIn profile data
          const profile = JSON.parse(atob(linkedInData));
          console.log('‚úì LinkedIn profile loaded:', profile);
          
          // Pre-fill form fields
          prefillFromLinkedIn(profile);
          
          // Show success message
          const successMsg = document.getElementById('linkedInSuccess');
          const importSection = document.getElementById('linkedInImportSection');
          
          if (successMsg) successMsg.style.display = 'block';
          if (importSection) importSection.style.display = 'none';
          
          // Clean URL
          window.history.replaceState({}, '', '/onboarding.html');
          
        } catch (error) {
          console.error('Error parsing LinkedIn data:', error);
        }
      }
    }
    
    function prefillFromLinkedIn(profile) {
      // Pre-fill name (will be asked in step 6)
      const displayName = `${profile.firstName} ${profile.lastName}`.trim();
      if (displayName) {
        localStorage.setItem('linkedin_displayName', displayName);
      }
      
      // Pre-fill email (step 1)
      if (profile.email) {
        // Email isn't in step 1, but we can store it for later
        localStorage.setItem('linkedin_email', profile.email);
      }
      
      // Pre-fill headline as role (step 1)
      if (profile.headline) {
        // Try to extract skills from headline
        const headline = profile.headline.toLowerCase();
        const skillKeywords = [
          'marketing', 'engineer', 'developer', 'designer', 'product', 
          'manager', 'data', 'analyst', 'growth', 'seo', 'sales'
        ];
        
        // Auto-add skills based on headline
        const foundSkills = [];
        skillKeywords.forEach(keyword => {
          if (headline.includes(keyword)) {
            foundSkills.push(keyword);
          }
        });
        
        if (foundSkills.length > 0) {
          localStorage.setItem('linkedin_skills', JSON.stringify(foundSkills));
          console.log('‚úì Detected skills from headline:', foundSkills);
        }
      }
      
      // Store full profile for later use
      localStorage.setItem('linkedin_profile', JSON.stringify(profile));
      
      console.log('‚úì LinkedIn data stored for pre-filling');
    }
    
    // Load smart opportunity suggestions based on selected skills
    async function loadSmartOpportunities() {
      const loading = document.getElementById('opportunitiesLoading');
      const grid = document.getElementById('opportunitiesGrid');
      const note = document.getElementById('suggestionsNote');
      
      // Only load once
      if (grid && grid.dataset.loaded === 'true') return;
      
      try {
        // Show loading
        if (loading) loading.style.display = 'block';
        if (grid) grid.innerHTML = '';
        
        // Get selected skills
        const skills = window.getSelectedSkills ? window.getSelectedSkills() : [];
        console.log('Loading opportunities for skills:', skills);
        
        if (skills.length === 0) {
          // No skills - show generic options
          renderGenericOpportunities();
          return;
        }
        
        // Fetch suggestions from API
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
          ? 'http://localhost:3000/api'
          : '/api';
        
        const response = await fetch(`${API_BASE}/opportunities/suggest?skills=${skills.join(',')}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch suggestions');
        }
        
        const data = await response.json();
        console.log('‚úì Smart opportunities loaded:', data);
        
        // Hide loading
        if (loading) loading.style.display = 'none';
        
        // Update note
        if (note) note.textContent = `‚ú® Personalized for your skills`;
        
        // Render opportunities
        renderOpportunities(data.opportunities || []);
        
        if (grid) grid.dataset.loaded = 'true';
        
      } catch (error) {
        console.error('Error loading opportunities:', error);
        if (loading) loading.style.display = 'none';
        renderGenericOpportunities();
      }
    }
    
    function renderOpportunities(opportunities) {
      const grid = document.getElementById('opportunitiesGrid');
      if (!grid) return;
      
      if (opportunities.length === 0) {
        grid.innerHTML = '<div class="small muted" style="padding: 40px; text-align: center;">No suggestions available. Please go back and add more skills.</div>';
        return;
      }
      
      // Render first 12 opportunities
      grid.innerHTML = opportunities.slice(0, 12).map((opp, idx) => `
        <div class="option-card ${idx < 3 ? 'active' : ''}" data-category="${opp.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">
          <div class="option-card-header">
            <div class="switch ${idx < 3 ? 'on' : ''}" data-label="${opp}"></div>
            <h3>${opp}</h3>
          </div>
        </div>
      `).join('');
      
      // Add click handlers
      grid.querySelectorAll('.option-card').forEach(card => {
        card.addEventListener('click', () => {
          card.classList.toggle('active');
          const switchEl = card.querySelector('.switch');
          if (switchEl) switchEl.classList.toggle('on');
        });
      });
    }
    
    function renderGenericOpportunities() {
      const grid = document.getElementById('opportunitiesGrid');
      const note = document.getElementById('suggestionsNote');
      if (!grid) return;
      
      if (note) note.textContent = '';
      
      // Get seniority to customize options
      const seniority = document.getElementById('seniorityLevel')?.value;
      const isExecOrLead = seniority === 'Executive' || seniority === 'Lead';
      
      const genericOps = [
        'Consulting calls',
        'Advisory sessions',
        'Strategy workshops',
        'Expert review & feedback',
        'Training sessions',
        'Fractional retainers (10-20 hrs/week)',
        'Full-time contract work',
        'Project-based work',
        'Code review',
        'Async sprint work',
        isExecOrLead ? 'Executive advisory' : 'Skill-building projects',
        'Research & analysis'
      ];
      
      renderOpportunities(genericOps);
    }
    
    // Industries selector
    let selectedIndustries = [];
    let industriesData = [];
    
    // Load industries from API
    fetch('/api/industries')
      .then(res => res.json())
      .then(data => {
        industriesData = data.industries || [];
        renderIndustriesList();
      })
      .catch(err => {
        console.error('Error loading industries:', err);
        // Fallback industries
        industriesData = [
          { name: 'SaaS', popular: true },
          { name: 'E-commerce', popular: true },
          { name: 'Fintech', popular: true },
          { name: 'Healthtech', popular: true },
          { name: 'AI/ML', popular: true },
          { name: 'Developer Tools', popular: true },
          { name: 'Cloud Infrastructure', popular: true },
          { name: 'Mobile Apps', popular: true },
          { name: 'Web3/Crypto', popular: true },
          { name: 'Marketplaces', popular: true }
        ];
        renderIndustriesList();
      });
    
    function renderIndustriesList() {
      const list = document.getElementById('industriesList');
      if (!list) return;
      
      list.innerHTML = industriesData.map(industry => `
        <label style="display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
          <input type="checkbox" value="${industry.name}" onchange="toggleIndustry('${industry.name}')" ${selectedIndustries.includes(industry.name) ? 'checked' : ''}>
          <span>${industry.name}</span>
          ${industry.popular ? '<span class="chip" style="font-size: 11px; padding: 2px 6px; margin-left: auto;">Popular</span>' : ''}
        </label>
      `).join('');
    }
    
    function toggleIndustry(industry) {
      if (selectedIndustries.includes(industry)) {
        selectedIndustries = selectedIndustries.filter(i => i !== industry);
      } else {
        selectedIndustries.push(industry);
      }
      updateIndustriesDisplay();
    }
    
    function updateIndustriesDisplay() {
      const selector = document.getElementById('industriesSelector');
      const placeholder = document.getElementById('industriesPlaceholder');
      
      if (selectedIndustries.length === 0) {
        placeholder.style.display = 'block';
        return;
      }
      
      placeholder.style.display = 'none';
      selector.innerHTML = selectedIndustries.map(industry => `
        <div class="chip" style="display: flex; align-items: center; gap: 6px;">
          ${industry}
          <button type="button" onclick="removeIndustry('${industry}')" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 16px;">&times;</button>
        </div>
      `).join('') + '<div class="small muted" style="width: 100%; text-align: center; padding: 20px 0; display: none;" id="industriesPlaceholder">Click to select industries...</div>';
    }
    
    function removeIndustry(industry) {
      selectedIndustries = selectedIndustries.filter(i => i !== industry);
      updateIndustriesDisplay();
      renderIndustriesList();
    }
    
    function clearIndustries() {
      selectedIndustries = [];
      updateIndustriesDisplay();
      renderIndustriesList();
    }
    
    function closeIndustriesModal() {
      document.getElementById('industriesModal').style.display = 'none';
    }
    
    // Open modal when clicking selector
    document.getElementById('industriesSelector')?.addEventListener('click', () => {
      document.getElementById('industriesModal').style.display = 'flex';
    });
    
    // Make selected industries available globally
    window.getSelectedIndustries = () => selectedIndustries;
    
    // AI-powered Get Help functionality
    let suggestionLoading = false;
    
    window.getSuggestion = async function(field) {
      if (suggestionLoading) {
        alert('Please wait for the current suggestion to finish...');
        return;
      }
      
      // Gather context
      const seniorityLevel = document.getElementById('seniorityLevel')?.value || 'Senior';
      // Derive years from seniority
      const yearsMap = { 'Junior': 2, 'Mid': 4, 'Senior': 8, 'Lead': 12, 'Executive': 18 };
      const yearsExperience = yearsMap[seniorityLevel] || 6;
      
      const context = {
        skills: window.getSelectedSkills ? window.getSelectedSkills() : [],
        seniorityLevel: seniorityLevel,
        yearsExperience: yearsExperience,
        currentCompany: document.getElementById('currentCompany')?.value || '',
        industries: window.getSelectedIndustries ? window.getSelectedIndustries() : [],
        location: document.getElementById('location')?.value || '',
        professionalTitle: document.getElementById('professionalTitle')?.value || ''
      };
      
      // Show loading
      suggestionLoading = true;
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚è≥ Thinking...';
      button.disabled = true;
      
      try {
        const response = await fetch('/api/suggest/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ field, context })
        });
        
        if (!response.ok) {
          throw new Error('Failed to get suggestion');
        }
        
        const data = await response.json();
        
        // Apply suggestion to the appropriate field
        if (field === 'title') {
          document.getElementById('professionalTitle').value = data.suggestion;
        } else if (field === 'bio') {
          document.getElementById('bio').value = data.suggestion;
        } else if (field === 'best_at') {
          const inputs = document.querySelectorAll('.best-at-input');
          const suggestions = Array.isArray(data.suggestion) ? data.suggestion : [data.suggestion];
          suggestions.forEach((text, i) => {
            if (inputs[i]) inputs[i].value = text;
          });
        } else if (field === 'highlights') {
          const inputs = document.querySelectorAll('.highlight-input');
          const suggestions = Array.isArray(data.suggestion) ? data.suggestion : [data.suggestion];
          suggestions.forEach((text, i) => {
            if (inputs[i]) inputs[i].value = text;
          });
        }
        
        // Show success briefly
        button.textContent = '‚úÖ Added!';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
          suggestionLoading = false;
        }, 2000);
        
      } catch (error) {
        console.error('Suggestion error:', error);
        alert('Could not generate suggestion. Please try again or write it yourself.');
        button.textContent = originalText;
        button.disabled = false;
        suggestionLoading = false;
      }
    };
  </script>
</body>
</html>

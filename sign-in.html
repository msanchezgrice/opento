<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sign In ‚Äî Opento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
</head>
<body>
  <!-- Auth Modals (for switching between sign-in/sign-up) -->
  <div id="authModal" class="modal auth-modal" style="display: none;">
    <div class="dialog auth-dialog" style="max-width: 480px; width: 100%; max-height: 90vh; overflow-y: auto;">
      <header class="auth-modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 1;">
        <div style="font-weight: 700; font-size: 20px; color: var(--text);" id="authModalTitle">Sign In</div>
        <button class="btn small gray" id="closeAuthModal" style="padding: 8px 12px; min-width: auto; border-radius: 8px; background: transparent; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--soft)'" onmouseout="this.style.background='transparent'">‚úï</button>
      </header>
      <main style="padding: 32px 24px;">
        <div id="clerk-auth-container" style="width: 100%;"></div>
      </main>
    </div>
  </div>
  <div class="nav">
    <a href="index.html" class="brand" style="text-decoration: none; color: inherit;"><img class="brand-logo" src="assets/logo.svg" alt="Opento"><div class="brand-name">Opento</div></a>
    <div class="actions">
      <a class="btn gray" href="#" onclick="openAuthModal('sign-up'); return false;">Sign up</a>
      <a class="btn primary" href="index.html">Home</a>
    </div>
  </div>

  <div class="container section" style="max-width: 480px; margin: 60px auto;">
    <h2 style="text-align: center;">Welcome back</h2>
    <p class="lead" style="text-align: center;">Sign in to your Opento account</p>
    
    <!-- Clerk Sign In Component will mount here -->
    <div id="clerk-sign-in"></div>

    <div style="text-align: center; margin-top: 20px;">
      <p class="small">Don't have an account? <a href="#" onclick="openAuthModal('sign-up'); return false;">Sign up</a></p>
    </div>
  </div>

  <!-- Clerk SDK -->
  <script>
    // Wait for config.js to load, then initialize Clerk
    function initClerk() {
      // Debug: Check if config loaded
      console.log('üîç Checking config...', {
        hasConfig: !!window.opentoConfig,
        hasClerk: !!window.opentoConfig?.clerk,
        hasKey: !!window.opentoConfig?.clerk?.publishableKey,
        keyValue: window.opentoConfig?.clerk?.publishableKey || 'MISSING'
      });

      const publishableKey = window.opentoConfig?.clerk?.publishableKey;
      
      if (!publishableKey) {
        console.error('‚ùå Clerk publishable key not found in config');
        // Don't show error message, just leave empty
        console.log('Clerk not configured');
        return;
      }

      // Verify key is valid before proceeding
      if (!publishableKey || publishableKey.length < 10) {
        throw new Error(`Invalid publishable key: "${publishableKey}". Expected key starting with pk_live_ or pk_test_`);
      }
      
      console.log('üîë Initializing Clerk with key:', publishableKey.substring(0, 20) + '...');
      console.log('üîç Full key length:', publishableKey.length);

      // Load Clerk script with crossorigin to avoid CORS issues
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js';
      script.crossOrigin = 'anonymous';
      script.async = true;
      
      script.onload = async () => {
        console.log('üì¶ Clerk script loaded from CDN');
        
        try {
          // Wait for Clerk to be available on window
          let attempts = 0;
          console.log('‚è≥ Waiting for window.Clerk...');
          while (!window.Clerk && attempts < 100) {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
          }
          
          console.log(`‚úì After ${attempts} attempts, window.Clerk exists:`, !!window.Clerk);
          
          if (!window.Clerk) {
            throw new Error('Clerk object not found after script load. Check network tab for clerk.browser.js');
          }

          // Initialize Clerk with the key
          console.log('‚úÖ Clerk object found, initializing with publishable key...');
          console.log('üîë Key to use:', publishableKey);
          
          await window.Clerk.load({
            publishableKey: publishableKey
          });
          
          console.log('‚úÖ Clerk.load() completed successfully');

          // Mount Clerk Sign In component
          const signInDiv = document.getElementById('clerk-sign-in');
          window.Clerk.mountSignIn(signInDiv, {
            afterSignInUrl: '/inbox',
            appearance: {
              elements: {
                rootBox: { margin: '0 auto' },
                card: { 
                  boxShadow: 'none',
                  border: '1px solid #E2E8F0'
                }
              }
            }
          });
          console.log('‚úÖ Clerk sign-in component mounted successfully');
        } catch (error) {
          console.error('‚ùå Clerk initialization error:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            clerkAvailable: !!window.Clerk,
            configAvailable: !!window.opentoConfig
          });
                // Don't show error in UI, just log it
                console.error('Authentication error details:', error);
        }
      };
      
      script.onerror = (error) => {
        console.error('‚ùå Failed to load Clerk script from CDN', error);
        // Don't show error in UI
      };
      
      document.head.appendChild(script);
    }

    // Wait for config.js to load before initializing Clerk
    function waitForConfig() {
      if (window.opentoConfig && window.opentoConfig.clerk && window.opentoConfig.clerk.publishableKey) {
        console.log('‚úÖ Config loaded, initializing Clerk...');
        initClerk();
      } else {
        // Check again after a short delay, but timeout after 5 seconds
        if (Date.now() - waitForConfig.startTime < 5000) {
          setTimeout(waitForConfig, 50);
        } else {
          console.error('‚ùå Config.js failed to load after 5 seconds');
          console.error('Config check:', {
            opentoConfig: window.opentoConfig,
            clerk: window.opentoConfig?.clerk,
            key: window.opentoConfig?.clerk?.publishableKey
          });
          // Don't show error in UI
        }
      }
    }
    waitForConfig.startTime = Date.now();

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForConfig);
    } else {
      waitForConfig();
    }
  </script>
  <script src="lib/auth-modal.js"></script>
</body>
</html>
